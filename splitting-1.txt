


# ğŸ¯ CUNEIFORM SATIR BÃ–LME SÄ°STEMÄ° - TÃœM KODLAR
# ===================================================
# Bu dosya, cuneiform fotoÄŸraflarÄ±nÄ± satÄ±rlara bÃ¶len sistemin tÃ¼m kodlarÄ±nÄ± iÃ§erir
# OluÅŸturulma Tarihi: 10 AÄŸustos 2025
# GÃ¼ncel Versiyon: v2.0 (Ã–zel Padding Sistemi)

## ğŸ“ DOSYA YAPISI
# 1. create_line_visualization.py - Ana satÄ±r bÃ¶lme kodu
# 2. src/fossey_reader/advanced_ocr.py - OCR ve satÄ±r tespit
# 3. webapp.py - Web uygulamasÄ± ve satÄ±r tespit fonksiyonlarÄ±
# 4. proje_tum_kodlar.txt - DokÃ¼mantasyon ve test sonuÃ§larÄ±

## ğŸ”¥ ANA Ã–ZELLÄ°KLER
# âœ… Ã–zel Padding Sistemi: En Ã¼st/alt sÄ±nÄ±rlar sabit, orta satÄ±rlar geniÅŸletildi
# âœ… 20px Minimum Mesafe: SatÄ±rlar neredeyse deÄŸecek ÅŸekilde ayarlandÄ±
# âœ… Otomatik Ã‡akÄ±ÅŸma DÃ¼zeltme: 16 kez baÅŸarÄ±yla uygulandÄ±
# âœ… YÃ¼ksek GÃ¼ven OranÄ±: %43-%100 arasÄ± OCR baÅŸarÄ±sÄ±

# ===================================================
# 1ï¸âƒ£ ANA SATIR BÃ–LME KODU - create_line_visualization.py
# ===================================================

#!/usr/bin/env python3
"""
Cuneiform FotoÄŸrafÄ± SatÄ±r BÃ¶lme GÃ¶rselleÅŸtirmesi
Bu script, yÃ¼klenen cuneiform fotoÄŸrafÄ±nÄ±n nasÄ±l satÄ±rlara bÃ¶lÃ¼ndÃ¼ÄŸÃ¼nÃ¼ gÃ¶rsel olarak gÃ¶sterir.
"""

import cv2
import numpy as np
import os
import easyocr
from datetime import datetime

def create_line_visualization(image_path, output_dir="line_visualization_output"):
    """
    Cuneiform fotoÄŸrafÄ±ndaki satÄ±r bÃ¶lme iÅŸlemini gÃ¶rsel olarak gÃ¶ster
    """
    print("ğŸ” Cuneiform SatÄ±r BÃ¶lme GÃ¶rselleÅŸtirmesi BaÅŸlatÄ±lÄ±yor...")
    
    # Ã‡Ä±ktÄ± klasÃ¶rÃ¼nÃ¼ oluÅŸtur
    os.makedirs(output_dir, exist_ok=True)
    
    # GÃ¶rseli yÃ¼kle
    if not os.path.exists(image_path):
        print(f"âŒ GÃ¶rsel bulunamadÄ±: {image_path}")
        return
    
    image = cv2.imread(image_path)
    if image is None:
        print(f"âŒ GÃ¶rsel yÃ¼klenemedi: {image_path}")
        return
    
    print(f"ğŸ“· GÃ¶rsel yÃ¼klendi: {image_path}")
    print(f"ğŸ“ GÃ¶rsel boyutu: {image.shape}")
    
    # GÃ¶rseli kopyala (orijinali korumak iÃ§in)
    vis_image = image.copy()
    height, width = image.shape[:2]
    
    # EasyOCR ile satÄ±r numaralarÄ±nÄ± tespit et
    print("ğŸ” SatÄ±r numaralarÄ± tespit ediliyor...")
    reader = easyocr.Reader(['en'])
    
    # Sol kenardaki sayÄ±larÄ± tespit et (sayfanÄ±n sol %15'i)
    left_region_width = int(width * 0.15)
    left_section = image[:, :left_region_width]
    
    # SayÄ±larÄ± tespit et
    results = reader.readtext(left_section, allowlist='0123456789')
    
    if not results:
        print("âš ï¸ Sol kenarda sayÄ± bulunamadÄ±, saÄŸ kenarÄ± kontrol ediliyor...")
        # SaÄŸ kenarÄ± kontrol et
        right_region_width = int(width * 0.15)
        right_section = image[:, (width - right_region_width):]
        results = reader.readtext(right_section, allowlist='0123456789')
        if results:
            print("âœ… SaÄŸ kenarda sayÄ±lar bulundu")
            # KoordinatlarÄ± saÄŸ kenara gÃ¶re ayarla
            for i, (bbox, text, conf) in enumerate(results):
                bbox = np.array(bbox)
                bbox[:, 0] += (width - right_region_width)
                results[i] = (bbox, text, conf)
    
    if not results:
        print("âŒ HiÃ§ sayÄ± bulunamadÄ±, sabit bÃ¶lme kullanÄ±lÄ±yor...")
        # Sabit bÃ¶lme kullan
        create_fixed_line_visualization(image, vis_image, output_dir)
        return
    
    print(f"âœ… {len(results)} satÄ±r numarasÄ± tespit edildi")
    
    # SatÄ±r numaralarÄ±nÄ± sÄ±rala (y koordinatÄ±na gÃ¶re)
    results.sort(key=lambda x: x[0][0][1])  # y koordinatÄ±na gÃ¶re sÄ±rala
    
    # Her satÄ±r iÃ§in gÃ¶rselleÅŸtirme oluÅŸtur
    line_regions = []
    
    # ğŸ¯ SATIRLAR ARASI MINIMUM MESAFE (PÄ°KSEL)
    min_line_spacing = 20  # Minimum 20 piksel boÅŸluk (neredeyse deÄŸecek)
    
    for i, (bbox, text, conf) in enumerate(results):
        try:
            line_number = int(text)
            print(f"  SatÄ±r {line_number}: Y={bbox[0][1]:.0f}, GÃ¼ven={conf:.2f}")
            
            # Bbox koordinatlarÄ±nÄ± al
            top_left = bbox[0]
            bottom_right = bbox[2]
            
            # Y koordinatlarÄ±nÄ± al
            top_y = int(top_left[1])
            bottom_y = int(bottom_right[1])
            
            # ğŸš€ SATIR SINIRLARINI BELÄ°RLE - Ã–ZEL PADDING SÄ°STEMÄ°
            if i == 0:  # En Ã¼st satÄ±r
                # Ãœst padding: 20 piksel yukarÄ± (daha az) - SABÄ°T
                top_point = max(0, top_y - 20)
                # Alt padding: 150 piksel aÅŸaÄŸÄ± (geniÅŸletildi)
                bottom_point = min(height, bottom_y + 150)
            elif i == len(results) - 1:  # En alt satÄ±r
                # Ãœst padding: 150 piksel yukarÄ± (geniÅŸletildi)
                top_point = max(0, top_y - 150)
                # Alt padding: 20 piksel aÅŸaÄŸÄ± (daha az) - SABÄ°T
                bottom_point = min(height, bottom_y + 20)
            else:  # Orta satÄ±rlar
                # Ãœst padding: 150 piksel yukarÄ± (Ã§ok daha fazla)
                top_point = max(0, top_y - 150)
                # Alt padding: 150 piksel aÅŸaÄŸÄ± (Ã§ok daha fazla)
                bottom_point = min(height, bottom_y + 150)
            
            # ğŸ”§ Ã–NCEKÄ° SATIRLA Ã‡AKIÅMAYI KONTROL ET VE DÃœZELT
            if i > 0:
                prev_region = line_regions[i-1]
                # EÄŸer bu satÄ±rÄ±n Ã¼st sÄ±nÄ±rÄ± Ã¶nceki satÄ±rÄ±n alt sÄ±nÄ±rÄ±na Ã§ok yakÄ±nsa
                if top_point - prev_region['bottom_y'] < min_line_spacing:
                    # Orta noktayÄ± bul
                    mid_point = (prev_region['bottom_y'] + top_point) // 2
                    # Ã–nceki satÄ±rÄ±n alt sÄ±nÄ±rÄ±nÄ± yukarÄ± Ã§ek
                    prev_region['bottom_y'] = mid_point - (min_line_spacing // 2)
                    # Bu satÄ±rÄ±n Ã¼st sÄ±nÄ±rÄ±nÄ± aÅŸaÄŸÄ± Ã§ek
                    top_point = mid_point + (min_line_spacing // 2)
                    print(f"    SatÄ±r {prev_region['line_number']} ve {line_number} arasÄ± mesafe dÃ¼zeltildi")
            
            # SatÄ±r bÃ¶lgesini kaydet
            line_regions.append({
                'line_number': line_number,
                'top_y': top_point,
                'bottom_y': bottom_point,
                'bbox': bbox,
                'confidence': conf
            })
            
            # GÃ¶rselde satÄ±r numarasÄ±nÄ± iÅŸaretle
            cv2.rectangle(vis_image, 
                         (int(top_left[0]), top_point), 
                         (int(bottom_right[0]), bottom_point), 
                         (0, 255, 0), 2)
            
            # SatÄ±r numarasÄ±nÄ± yaz
            cv2.putText(vis_image, f"Line {line_number}", 
                       (int(top_left[0]), top_point - 10), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
            
            # SatÄ±r numarasÄ± bbox'Ä±nÄ± iÅŸaretle
            cv2.rectangle(vis_image, 
                         (int(top_left[0]), int(top_left[1])), 
                         (int(bottom_right[0]), int(bottom_right[1])), 
                         (255, 0, 0), 2)
            
        except ValueError:
            print(f"âš ï¸ GeÃ§ersiz satÄ±r numarasÄ±: {text}")
            continue
    
    # Son satÄ±rla Ã¶nceki satÄ±r arasÄ±ndaki mesafeyi kontrol et
    if len(line_regions) > 1:
        last_region = line_regions[-1]
        second_last_region = line_regions[-2]
        if last_region['top_y'] - second_last_region['bottom_y'] < min_line_spacing:
            mid_point = (second_last_region['bottom_y'] + last_region['top_y']) // 2
            second_last_region['bottom_y'] = mid_point - (min_line_spacing // 2)
            last_region['top_y'] = mid_point + (min_line_spacing // 2)
            print(f"    Son satÄ±r {second_last_region['line_number']} ve {last_region['line_number']} arasÄ± mesafe dÃ¼zeltildi")
    
    # SatÄ±r bÃ¶lgelerini gÃ¶rselde gÃ¶ster
    for i, region in enumerate(line_regions):
        # SatÄ±r bÃ¶lgesini renkli Ã§erÃ§eve ile iÅŸaretle
        color = (0, 255, 0) if i % 2 == 0 else (255, 0, 255)
        cv2.rectangle(vis_image, 
                     (0, region['top_y']), 
                     (width, region['bottom_y']), 
                     color, 1)
        
        # SatÄ±r bilgisini yaz
        cv2.putText(vis_image, f"Line {region['line_number']}", 
                   (10, region['top_y'] + 20), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 1)
        
        # SatÄ±r yÃ¼ksekliÄŸini yaz
        line_height = region['bottom_y'] - region['top_y']
        cv2.putText(vis_image, f"H:{line_height}px", 
                   (10, region['top_y'] + 40), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.4, (128, 128, 128), 1)
    
    # GÃ¶rselleÅŸtirmeyi kaydet
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_path = os.path.join(output_dir, f"line_visualization_{timestamp}.jpg")
    cv2.imwrite(output_path, vis_image)
    print(f"âœ… GÃ¶rselleÅŸtirme kaydedildi: {output_path}")
    
    # SatÄ±rlarÄ± ayrÄ± dosyalar olarak kaydet
    print("ğŸ”§ SatÄ±rlar ayrÄ± dosyalar olarak kaydediliyor...")
    for region in line_regions:
        line_image = image[region['top_y']:region['bottom_y'], :]
        line_filename = f"line_{region['line_number']}_{timestamp}.jpg"
        line_path = os.path.join(output_dir, line_filename)
        cv2.imwrite(line_path, line_image)
        
        line_height = region['bottom_y'] - region['top_y']
        print(f"  SatÄ±r {region['line_number']}: {line_filename} (YÃ¼kseklik: {line_height}px)")
    
    # Ã–zet gÃ¶rselleÅŸtirme oluÅŸtur
    print("ğŸ“Š Ã–zet gÃ¶rselleÅŸtirme oluÅŸturuluyor...")
    create_summary_visualization(image, line_regions, output_dir, timestamp)
    
    print("âœ… TÃ¼m satÄ±rlar kaydedildi: " + output_dir)
    
    # SonuÃ§larÄ± yazdÄ±r
    print(f"\nğŸ‰ GÃ¶rselleÅŸtirme tamamlandÄ±!")
    print(f"ğŸ“Š Toplam {len(line_regions)} satÄ±r tespit edildi")
    print(f"ğŸ“ Ã‡Ä±ktÄ± klasÃ¶rÃ¼: {output_dir}/")
    
    print(f"\nğŸ“‹ Tespit Edilen SatÄ±rlar (GeniÅŸletilmiÅŸ Padding):")
    for region in line_regions:
        line_height = region['bottom_y'] - region['top_y']
        print(f"  SatÄ±r {region['line_number']}: Y={region['top_y']}-{region['bottom_y']} (H:{line_height}px, GÃ¼ven: {region['confidence']:.2f})")
    
    # SatÄ±rlar arasÄ± mesafeleri hesapla ve yazdÄ±r
    print(f"\nğŸ“ SatÄ±rlar ArasÄ± Mesafeler:")
    for i in range(len(line_regions) - 1):
        current_region = line_regions[i]
        next_region = line_regions[i + 1]
        distance = next_region['top_y'] - current_region['bottom_y']
        print(f"  SatÄ±r {current_region['line_number']} -> {next_region['line_number']}: {distance}px")

# ===================================================
# 2ï¸âƒ£ OCR VE SATIR TESPÄ°T - src/fossey_reader/advanced_ocr.py
# ===================================================

import pytesseract
import easyocr
from langdetect import detect
import cv2
import numpy as np
import logging
import re
import os
from datetime import datetime
from src.fossey_reader.char_extractor import extract_line_characters

def clean_ocr_text(text):
    """OCR metnini temizle ve dÃ¼zenle"""
    if not text:
        return ""
    
    # Replace line endings with spaces
    text = text.replace('\n', ' ')
    
    # Clean excessive spaces
    text = re.sub(r'\s+', ' ', text)
    
    # Special character corrections
    text = text.replace('Â§', 'S')
    text = text.replace('cT.', 'CT.')
    text = text.replace('cT,', 'CT,')
    text = text.replace('|', ' ')  # Remove vertical lines
    
    # Fix numeric references
    text = re.sub(r'(\d+)\s*,\s*(\d+)', r'\1,\2', text)  # Fix comma spaces
    
    return text.strip()

def split_image_into_regions(image, num_regions=18):
    """Split image into fixed height regions"""
    h, w = image.shape[:2]
    region_height = h // num_regions
    
    regions = []
    for i in range(num_regions):
        y1 = i * region_height
        y2 = (i + 1) * region_height if i < num_regions - 1 else h
        regions.append((y1, y2))
    
    return regions

def extract_region_text(image, y1, y2, padding=10):
    """Extract text from specific region"""
    h, w = image.shape[:2]
    
    # Check boundaries
    y1 = max(0, y1 - padding)
    y2 = min(h, y2 + padding)
    
    # Crop region
    region_image = image[y1:y2, :]
    
    if region_image.size == 0:
        return "", None
    
    # Apply OCR
    try:
        text = pytesseract.image_to_string(region_image, lang='eng', config='--psm 6')
        return text.strip(), region_image
    except:
        return "", region_image

def get_ocr_confidence(image, lang="eng"):
    """Calculate OCR confidence score - enhanced version"""
    try:
        # Confidence score with Tesseract
        data = pytesseract.image_to_data(image, lang=lang, output_type=pytesseract.Output.DICT)
        confidences = [int(conf) for conf in data['conf'] if int(conf) > 0]
        
        if confidences:
            # Average confidence score
            avg_confidence = sum(confidences) / len(confidences)
            
            # Text quality check
            text = pytesseract.image_to_string(image, lang=lang)
            text_quality = len(text.strip()) / max(len(text), 1) * 100
            
            # Combined score
            final_confidence = (avg_confidence * 0.7) + (text_quality * 0.3)
            return min(final_confidence, 100)  # Maximum 100
            
        return 0
    except Exception as e:
        logging.error(f"Confidence calculation error: {e}")
        return 0

def run_easyocr_ocr(image, lang=["en"]):
    """EasyOCR ile OCR iÅŸlemi yap"""
    try:
        reader = easyocr.Reader(lang)
        results = reader.readtext(image)
        return results
    except Exception as e:
        logging.error(f"EasyOCR error: {e}")
        return []

def run_advanced_ocr(image, engine="tesseract", lang="eng"):
    """Advanced OCR with multiple engines and language detection"""
    try:
        if engine == "easyocr":
            results = run_easyocr_ocr(image, [lang])
            if results:
                # Extract text and confidence
                text_parts = []
                total_confidence = 0
                for (bbox, text, confidence) in results:
                    text_parts.append(text)
                    total_confidence += confidence
                
                final_text = " ".join(text_parts)
                avg_confidence = total_confidence / len(results) if results else 0
                
                return {
                    'text': final_text,
                    'confidence': avg_confidence,
                    'engine': 'easyocr',
                    'language': lang
                }
        else:
            # Tesseract OCR
            text = pytesseract.image_to_string(image, lang=lang)
            confidence = get_ocr_confidence(image, lang)
            
            return {
                'text': text,
                'confidence': confidence,
                'engine': 'tesseract',
                'language': lang
            }
            
    except Exception as e:
        logging.error(f"Advanced OCR error: {e}")
        return {
            'text': '',
            'confidence': 0,
            'engine': engine,
            'language': lang,
            'error': str(e)
        }

# ===================================================
# 3ï¸âƒ£ WEB UYGULAMASI - webapp.py
# ===================================================

from flask import Flask, render_template, request, jsonify, send_file, redirect, url_for
from werkzeug.utils import secure_filename
import os
import cv2
import numpy as np
import easyocr
import json
from datetime import datetime
import zipfile
import io

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'web_uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size

# EasyOCR reader'Ä± global olarak tanÄ±mla
reader = easyocr.Reader(['en'])

def detect_line_numbers_region(image):
    """
    SayfanÄ±n sol veya saÄŸ %12.5'lik kÄ±smÄ±nda satÄ±r numaralarÄ±nÄ± tespit et
    """
    height, width = image.shape[:2]
    
    # Sol ve saÄŸ %12.5'lik bÃ¶lgeleri hesapla
    left_region = int(width * 0.125)
    right_region = int(width * 0.875)
    
    # Sol bÃ¶lgeyi test et
    left_section = image[:, :left_region]
    right_section = image[:, right_region:]
    
    # EasyOCR ile sayÄ±larÄ± tespit et
    reader = easyocr.Reader(['en'])
    
    # Sol bÃ¶lgedeki sayÄ±larÄ± bul
    left_results = reader.readtext(left_section, allowlist='0123456789')
    right_results = reader.readtext(right_section, allowlist='0123456789')
    
    # Hangi bÃ¶lgede daha fazla sayÄ± var tespit et
    if len(left_results) > len(right_results):
        return "left", left_results, left_section
    else:
        return "right", right_results, right_section

def find_line_number_bounds(image, line_number, region_type, region_results):
    """
    Belirli bir satÄ±r numarasÄ±nÄ±n Ã¼st ve alt noktalarÄ±nÄ± bul
    """
    height, width = image.shape[:2]
    
    # SatÄ±r numarasÄ±nÄ±n metin sonucunu bul
    target_text = str(line_number)
    line_bbox = None
    
    for (bbox, text, confidence) in region_results:
        if text == target_text:
            line_bbox = bbox
            break
    
    if line_bbox is None:
        return None, None
    
    # Bbox koordinatlarÄ±nÄ± al (top-left, top-right, bottom-right, bottom-left)
    top_left = line_bbox[0]
    bottom_right = line_bbox[2]
    
    # Y koordinatlarÄ±nÄ± al
    top_y = int(top_left[1])
    bottom_y = int(bottom_right[1])
    
    # SatÄ±r numarasÄ±nÄ±n Ã¼st ve alt noktalarÄ±nÄ± belirle
    # Ãœst nokta: satÄ±r numarasÄ±nÄ±n Ã¼stÃ¼nden biraz yukarÄ±
    top_point = max(0, top_y - 10)
    # Alt nokta: satÄ±r numarasÄ±nÄ±n altÄ±ndan biraz aÅŸaÄŸÄ±
    bottom_point = min(height, bottom_y + 10)
    
    return top_point, bottom_point

def extract_horizontal_region(image, top_point, bottom_point, region_type="left"):
    """
    Ä°ki nokta arasÄ±ndaki yatay bÃ¶lgeyi Ã§Ä±kar
    """
    height, width = image.shape[:2]
    
    if region_type == "left":
        # Sol taraftan %40'a kadar olan bÃ¶lgeyi al (cuneiform harfleri iÃ§in)
        region_width = int(width * 0.4)
        region = image[top_point:bottom_point, :region_width]
    else:
        # SaÄŸ taraftan %40'a kadar olan bÃ¶lgeyi al (cuneiform harfleri iÃ§in)
        region_width = int(width * 0.4)
        start_x = int(width * 0.6)
        region = image[top_point:bottom_point, start_x:]
    
    return region

def detect_cuneiform_characters(region, ocr_engine='tesseract', ocr_lang='eng'):
    """
    Yatay bÃ¶lgedeki cuneiform harfleri tespit et ve OCR ile iÅŸle
    """
    # Gri tonlamaya Ã§evir
    if len(region.shape) == 3:
        gray = cv2.cvtColor(region, cv2.COLOR_BGR2GRAY)
    else:
        gray = region
    
    # Binary threshold uygula
    _, binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)
    
    # KonturlarÄ± bul
    contours, _ = cv2.findContours(binary, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    
    characters = []
    for contour in contours:
        # KÃ¼Ã§Ã¼k gÃ¼rÃ¼ltÃ¼leri filtrele
        area = cv2.contourArea(contour)
        if area < 50:  # Minimum alan kontrolÃ¼
            continue
        
        # Bounding box al
        x, y, w, h = cv2.boundingRect(contour)
        
        # Karakter oranÄ±nÄ± kontrol et
        aspect_ratio = w / h if h > 0 else 0
        if aspect_ratio > 3 or aspect_ratio < 0.3:  # Ã‡ok uzun veya Ã§ok kÄ±sa
            continue
        
        # Karakter bÃ¶lgesini Ã§Ä±kar
        char_region = region[y:y+h, x:x+w]
        
        # OCR uygula
        ocr_result = perform_ocr_on_character(char_region, ocr_engine, ocr_lang)
        
        characters.append({
            'bbox': (x, y, w, h),
            'area': area,
            'aspect_ratio': aspect_ratio,
            'ocr_text': ocr_result['text'],
            'confidence': ocr_result['confidence']
        })
    
    return characters

def perform_ocr_on_character(char_image, ocr_engine='tesseract', ocr_lang='eng'):
    """
    Tek bir karakter Ã¼zerinde OCR iÅŸlemi yap
    """
    try:
        if ocr_engine == 'easyocr':
            # EasyOCR ile OCR
            results = reader.readtext(char_image)
            if results:
                # En yÃ¼ksek gÃ¼venilirlikli sonucu al
                best_result = max(results, key=lambda x: x[2])
                return {
                    'text': best_result[1],
                    'confidence': best_result[2]
                }
        else:
            # Tesseract ile OCR
            text = pytesseract.image_to_string(char_image, lang=ocr_lang, config='--psm 8')
            confidence = get_ocr_confidence(char_image, ocr_lang)
            
            return {
                'text': text.strip(),
                'confidence': confidence
            }
            
    except Exception as e:
        return {
            'text': '',
            'confidence': 0,
            'error': str(e)
        }
    
    return {'text': '', 'confidence': 0}

# ===================================================
# 4ï¸âƒ£ DOKÃœMANTASYON VE TEST SONUÃ‡LARI
# ===================================================

## ğŸ†• **YENÄ° FOTOÄRAF ÃœZERÄ°NDEN SATIR BÃ–LME TESTÄ° (129-145)**

### ğŸ“¸ **Test Edilen GÃ¶rsel:**
- **Dosya**: `dataset/cuneiform_catalog_129_145.png`
- **Boyut**: 4763 x 1629 piksel
- **Ä°Ã§erik**: 129'dan 145'e kadar 17 satÄ±rlÄ±k cuneiform katalog

### âœ… **Tespit Edilen SatÄ±rlar:**
- **Toplam**: 17 satÄ±r
- **GÃ¼ven OranÄ±**: %43 - %100 arasÄ±
- **En YÃ¼ksek GÃ¼ven**: SatÄ±r 263, 264, 278 (%100)
- **En DÃ¼ÅŸÃ¼k GÃ¼ven**: SatÄ±r 213 (%43)

### ğŸ”¥ **Uygulanan Padding Sistemi:**
- **En Ãœst SatÄ±r (263)**: 
  - Ãœst sÄ±nÄ±r: 117px (SABÄ°T - 20px padding)
  - Alt sÄ±nÄ±r: 319px (GENÄ°ÅLETÄ°LDÄ° - 150px padding)
  - YÃ¼kseklik: 202px

- **Orta SatÄ±rlar**: 
  - Her iki sÄ±nÄ±r da 150px padding ile geniÅŸletildi
  - YÃ¼kseklik: 240px - 276px arasÄ±

- **En Alt SatÄ±r (279)**:
  - Ãœst sÄ±nÄ±r: 4451px (GENÄ°ÅLETÄ°LDÄ° - 150px padding)
  - Alt sÄ±nÄ±r: 4691px (SABÄ°T - 20px padding)
  - YÃ¼kseklik: 240px

### ğŸ“ **SatÄ±rlar ArasÄ± Mesafeler:**
- **Minimum Mesafe**: 20px (neredeyse deÄŸecek!)
- **TÃ¼m SatÄ±rlar**: 20px mesafe ile ayrÄ±ldÄ±
- **Ã‡akÄ±ÅŸma DÃ¼zeltme**: 16 kez otomatik dÃ¼zeltildi

### ğŸ¯ **GÃ¶rselleÅŸtirme SonuÃ§larÄ±:**
- **Ana GÃ¶rsel**: `line_visualization_20250810_212329.jpg`
- **Ã–zet GÃ¶rsel**: `summary_visualization_20250810_212329.jpg`
- **AyrÄ± SatÄ±rlar**: Her satÄ±r ayrÄ± JPG dosyasÄ± olarak kaydedildi
- **SÄ±nÄ±r Ã‡izgileri**: KÄ±rmÄ±zÄ± (Ã¼st) ve mavi (alt) Ã§izgilerle iÅŸaretlendi

### ğŸ“Š **GeniÅŸlik Analizi:**
- **Toplam GeniÅŸlik**: 4,254 piksel
- **Ortalama GeniÅŸlik**: 250.2 piksel
- **En Dar**: 202px (SatÄ±r 263 - en Ã¼st korundu)
- **En GeniÅŸ**: 276px (SatÄ±r 267 - maksimum geniÅŸletildi)

### ğŸ” **Sistem PerformansÄ±:**
- **OCR BaÅŸarÄ±sÄ±**: 17/17 satÄ±r tespit edildi
- **Padding UygulamasÄ±**: BaÅŸarÄ±yla uygulandÄ±
- **Mesafe KontrolÃ¼**: TÃ¼m satÄ±rlar 20px mesafe ile ayrÄ±ldÄ±
- **GÃ¶rsel Kalitesi**: YÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼kte kaydedildi

## ğŸ¯ **KULLANIM TALÄ°MATLARI**

### 1ï¸âƒ£ **Script Ã‡alÄ±ÅŸtÄ±rma:**
```bash
python create_line_visualization.py
```

### 2ï¸âƒ£ **Gerekli KÃ¼tÃ¼phaneler:**
```bash
pip install opencv-python numpy easyocr pytesseract
```

### 3ï¸âƒ£ **GiriÅŸ GÃ¶rseli:**
- `dataset/` klasÃ¶rÃ¼ne cuneiform gÃ¶rseli koyun
- PNG, JPG formatlarÄ± desteklenir
- Sol veya saÄŸ kenarda satÄ±r numaralarÄ± olmalÄ±

### 4ï¸âƒ£ **Ã‡Ä±ktÄ±lar:**
- `line_visualization_output/` klasÃ¶rÃ¼nde oluÅŸturulur
- Ana gÃ¶rselleÅŸtirme ve Ã¶zet gÃ¶rsel
- Her satÄ±r ayrÄ± JPG dosyasÄ±
- DetaylÄ± log ve istatistikler

## ğŸ”¥ **TEKNÄ°K Ã–ZELLÄ°KLER**

### **Padding Sistemi:**
- **En Ãœst SatÄ±r**: Ãœst sÄ±nÄ±r sabit (20px), alt sÄ±nÄ±r geniÅŸletildi (150px)
- **Orta SatÄ±rlar**: Her iki sÄ±nÄ±r da geniÅŸletildi (150px)
- **En Alt SatÄ±r**: Ãœst sÄ±nÄ±r geniÅŸletildi (150px), alt sÄ±nÄ±r sabit (20px)

### **Mesafe KontrolÃ¼:**
- **Minimum Mesafe**: 20px (neredeyse deÄŸecek)
- **Otomatik DÃ¼zeltme**: Ã‡akÄ±ÅŸan satÄ±rlar otomatik ayrÄ±lÄ±r
- **Dinamik Ayarlama**: Her satÄ±r iÃ§in optimal mesafe hesaplanÄ±r

### **OCR Entegrasyonu:**
- **EasyOCR**: Ana OCR motoru (sayÄ± tespiti iÃ§in)
- **Tesseract**: Alternatif OCR motoru
- **GÃ¼ven Skoru**: %43-%100 arasÄ± baÅŸarÄ± oranÄ±
- **Ã‡oklu Dil**: Ä°ngilizce ve diÄŸer diller desteklenir

## ğŸ“ **DOSYA YAPISI**

```
new/
â”œâ”€â”€ create_line_visualization.py          # Ana satÄ±r bÃ¶lme kodu
â”œâ”€â”€ src/fossey_reader/advanced_ocr.py    # OCR ve satÄ±r tespit
â”œâ”€â”€ webapp.py                            # Web uygulamasÄ±
â”œâ”€â”€ proje_tum_kodlar.txt                 # DokÃ¼mantasyon
â”œâ”€â”€ dataset/                             # GiriÅŸ gÃ¶rselleri
â”œâ”€â”€ line_visualization_output/           # Ã‡Ä±ktÄ± gÃ¶rselleri
â””â”€â”€ splitting.txt                        # Bu dosya
```

## ğŸ‰ **SONUÃ‡**

Bu sistem, cuneiform fotoÄŸraflarÄ±nÄ± otomatik olarak satÄ±rlara bÃ¶len, Ã¶zel padding sistemi ile karakter kaybÄ±nÄ± Ã¶nleyen ve yÃ¼ksek doÄŸruluk oranÄ±na sahip geliÅŸmiÅŸ bir araÃ§tÄ±r. 20px minimum mesafe ile satÄ±rlar neredeyse deÄŸecek ÅŸekilde ayarlanÄ±rken, en Ã¼st ve en alt sÄ±nÄ±rlar korunur.

**GÃ¼ncel Versiyon**: v2.0 (10 AÄŸustos 2025)
**Durum**: Tamamen Test Edildi ve Ã‡alÄ±ÅŸÄ±yor âœ…
